{"version":3,"file":"raginterface.min.js","sources":["../src/raginterface.js"],"sourcesContent":["/* eslint-disable */\r\n// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * JavaScript for Terus RAG block.\r\n *\r\n * @module     block_terusrag/raginterface\r\n  * @copyright  2025 Khairu Aqsara <khairu@teruselearning.co.uk>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['core/ajax', 'core/notification', 'core/str'],\r\n    function(Ajax, Notification, Str) {\r\n    'use strict';\r\n\r\n    /**\r\n     * Module level variables.\r\n     */\r\n    var RAGInterface = {};\r\n    var SELECTORS = {\r\n        COMPONENT: '.block_terusrag',\r\n        FORM: '.rag-form',\r\n        QUERY_INPUT: '[data-region=\"query-input\"]',\r\n        SUBMIT_BUTTON: '[data-action=\"submit-query\"]',\r\n        RESPONSE_AREA: '[data-region=\"response-area\"]',\r\n        RESPONSE_CONTENT: '[data-region=\"response-content\"]',\r\n        RESPONSE_TEXT: '[data-region=\"response-text\"]',\r\n        RESPONSE_METADATA: '[data-region=\"response-metadata\"]',\r\n        LOADING_INDICATOR: '[data-region=\"loading-indicator\"]',\r\n        PLACEHOLDER: '[data-region=\"placeholder\"]'\r\n    };\r\n\r\n    /**\r\n     * Initialize the module.\r\n     *\r\n     * @param {string} selector The CSS selector for the RAG block\r\n     */\r\n    RAGInterface.init = function(selector) {\r\n        const container = document.querySelector(selector);\r\n        if (!container) {\r\n            return;\r\n        }\r\n\r\n        const form = container.querySelector(SELECTORS.FORM);\r\n        \r\n\r\n        form.addEventListener('submit', function(e) {\r\n            e.preventDefault();\r\n            const query = container.querySelector(SELECTORS.QUERY_INPUT).value.trim();\r\n            if (query) {\r\n                RAGInterface.submitQuery(container, query);\r\n            }\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Submit a query to the RAG system.\r\n     *\r\n     * @param {Element} container The RAG block container element\r\n     * @param {string} query The user's query\r\n     */\r\n    RAGInterface.submitQuery = function(container, query) {\r\n        const courseId = container.dataset.courseid;\r\n        const loadingIndicator = container.querySelector(SELECTORS.LOADING_INDICATOR);\r\n        const responseContent = container.querySelector(SELECTORS.RESPONSE_CONTENT);\r\n        const responseText = container.querySelector(SELECTORS.RESPONSE_TEXT);\r\n        const responseMetadata = container.querySelector(SELECTORS.RESPONSE_METADATA);\r\n        // Store a direct reference to the input field\r\n        const queryInputField = container.querySelector(SELECTORS.QUERY_INPUT);\r\n        const contentPlaceholder = container.querySelector(SELECTORS.PLACEHOLDER);\r\n\r\n        // Debug log\r\n        console.log('Query input found:', queryInputField);\r\n\r\n        // Show loading indicator\r\n        loadingIndicator.classList.remove('hidden');\r\n        contentPlaceholder.classList.add('hidden');\r\n        // Clear previous results\r\n        responseText.textContent = '';\r\n        responseMetadata.textContent = '';\r\n        responseContent.classList.remove('hidden');\r\n\r\n        // Make AJAX call\r\n        Ajax.call([{\r\n            methodname: 'block_terusrag_submit_query',\r\n            args: {\r\n                query: query,\r\n                courseid: courseId\r\n            },\r\n            done: function(response) {\r\n                // Clear the input field after successful submission\r\n                if (queryInputField) {\r\n                    queryInputField.value = '';\r\n                    console.log('Input field cleared');\r\n                } else {\r\n                    console.error('Query input field not found for clearing');\r\n                }\r\n                \r\n                loadingIndicator.classList.add('hidden');\r\n                // Check if answer exists and is an array\r\n                if (response.answer && Array.isArray(response.answer)) {\r\n                    // Display response with proper structure\r\n                    responseText.innerHTML = response.answer.map(function(item) {\r\n                        let content = `\r\n                            <div class=\"rag-response-item mb-3\">\r\n                                <h4 class=\"rag-response-title\">\r\n                                    <a href=\"${item.viewurl}\" target=\"_blank\">${item.title}</a>\r\n                                </h4>\r\n                                <div class=\"rag-response-content\" data-content-id=\"${item.id}\">\r\n                                    ${item.content}\r\n                                </div>\r\n                            </div>\r\n                        `;\r\n                        return content;\r\n                    }).join('');\r\n                } else {\r\n                    responseText.innerHTML = '<p>'+Str.get_string('noresultsfound', 'block_terusrag')+'</p>';\r\n                }\r\n\r\n                // Show metadata\r\n                responseMetadata.classList.remove('hidden'); // Ensure metadata container is visible\r\n                \r\n                // Format and display token usage information\r\n                if (response.promptTokenCount !== undefined && \r\n                    response.responseTokenCount !== undefined && \r\n                    response.totalTokenCount !== undefined) {\r\n                    \r\n                    Str.get_string('token_usage', 'block_terusrag', {\r\n                        prompt: response.promptTokenCount,\r\n                        response: response.responseTokenCount,\r\n                        total: response.totalTokenCount\r\n                    }).then(function(str) {\r\n                        responseMetadata.innerHTML = str;\r\n                        return;\r\n                    }).catch(Notification.exception);\r\n                } else {\r\n                    responseMetadata.innerHTML = '<div class=\"token-info\">'+Str.get_string('notokeninformation', 'block_terusrag')+'</div>';\r\n                }\r\n            },\r\n            fail: function(error) {\r\n                console.error('Query submission failed:', error);\r\n                Notification.exception(error);\r\n                loadingIndicator.classList.add('hidden');\r\n                contentPlaceholder.classList.remove('hidden');\r\n            }\r\n        }]);\r\n    };\r\n\r\n    return RAGInterface;\r\n});\r\n"],"names":["define","Ajax","Notification","Str","RAGInterface","SELECTORS","init","selector","container","document","querySelector","addEventListener","e","preventDefault","query","value","trim","submitQuery","courseId","dataset","courseid","loadingIndicator","responseContent","responseText","responseMetadata","queryInputField","contentPlaceholder","console","log","classList","remove","add","textContent","call","methodname","args","done","response","error","answer","Array","isArray","innerHTML","map","item","viewurl","title","id","content","join","get_string","undefined","promptTokenCount","responseTokenCount","totalTokenCount","prompt","total","then","str","catch","exception","fail"],"mappings":";;;;;;;AAwBAA,qCAAO,CAAC,YAAa,oBAAqB,aACtC,SAASC,KAAMC,aAAcC,SAMzBC,aAAe,GACfC,eAEM,YAFNA,sBAGa,8BAHbA,2BAMkB,mCANlBA,wBAOe,gCAPfA,4BAQmB,oCARnBA,4BASmB,oCATnBA,sBAUa,qCAQjBD,aAAaE,KAAO,SAASC,gBACnBC,UAAYC,SAASC,cAAcH,cACpCC,iBAIQA,UAAUE,cAAcL,gBAGhCM,iBAAiB,UAAU,SAASC,GACrCA,EAAEC,uBACIC,MAAQN,UAAUE,cAAcL,uBAAuBU,MAAMC,OAC/DF,OACAV,aAAaa,YAAYT,UAAWM,WAWhDV,aAAaa,YAAc,SAAST,UAAWM,aACrCI,SAAWV,UAAUW,QAAQC,SAC7BC,iBAAmBb,UAAUE,cAAcL,6BAC3CiB,gBAAkBd,UAAUE,cAAcL,4BAC1CkB,aAAef,UAAUE,cAAcL,yBACvCmB,iBAAmBhB,UAAUE,cAAcL,6BAE3CoB,gBAAkBjB,UAAUE,cAAcL,uBAC1CqB,mBAAqBlB,UAAUE,cAAcL,uBAGnDsB,QAAQC,IAAI,qBAAsBH,iBAGlCJ,iBAAiBQ,UAAUC,OAAO,UAClCJ,mBAAmBG,UAAUE,IAAI,UAEjCR,aAAaS,YAAc,GAC3BR,iBAAiBQ,YAAc,GAC/BV,gBAAgBO,UAAUC,OAAO,UAGjC7B,KAAKgC,KAAK,CAAC,CACPC,WAAY,8BACZC,KAAM,CACFrB,MAAOA,MACPM,SAAUF,UAEdkB,KAAM,SAASC,UAEPZ,iBACAA,gBAAgBV,MAAQ,GACxBY,QAAQC,IAAI,wBAEZD,QAAQW,MAAM,4CAGlBjB,iBAAiBQ,UAAUE,IAAI,UAE3BM,SAASE,QAAUC,MAAMC,QAAQJ,SAASE,QAE1ChB,aAAamB,UAAYL,SAASE,OAAOI,KAAI,SAASC,wMAI3BA,KAAKC,qCAA4BD,KAAKE,iJAEAF,KAAKG,sDACpDH,KAAKI,qHAKpBC,KAAK,IAER1B,aAAamB,UAAY,MAAMvC,IAAI+C,WAAW,iBAAkB,kBAAkB,OAItF1B,iBAAiBK,UAAUC,OAAO,eAGAqB,IAA9Bd,SAASe,uBACuBD,IAAhCd,SAASgB,yBACoBF,IAA7Bd,SAASiB,gBAETnD,IAAI+C,WAAW,cAAe,iBAAkB,CAC5CK,OAAQlB,SAASe,iBACjBf,SAAUA,SAASgB,mBACnBG,MAAOnB,SAASiB,kBACjBG,MAAK,SAASC,KACblC,iBAAiBkB,UAAYgB,OAE9BC,MAAMzD,aAAa0D,WAEtBpC,iBAAiBkB,UAAY,2BAA2BvC,IAAI+C,WAAW,qBAAsB,kBAAkB,UAGvHW,KAAM,SAASvB,OACXX,QAAQW,MAAM,2BAA4BA,OAC1CpC,aAAa0D,UAAUtB,OACvBjB,iBAAiBQ,UAAUE,IAAI,UAC/BL,mBAAmBG,UAAUC,OAAO,eAKzC1B"}